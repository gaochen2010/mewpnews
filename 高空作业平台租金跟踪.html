<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒé«˜ç©ºä½œä¸šå¹³å°ç§Ÿé‡‘ä»·æ ¼è·Ÿè¸ª</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }

        .controls {
            padding: 30px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-item {
            flex: 1;
            min-width: 200px;
        }

        .control-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
            font-size: 0.9em;
        }

        .control-item select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-item select:hover {
            border-color: #667eea;
        }

        .control-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .content {
            padding: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: 300;
            color: #495057;
        }

        .stat-card .change {
            font-size: 0.85em;
            margin-top: 8px;
            color: #28a745;
        }

        .stat-card .change.negative {
            color: #dc3545;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 500;
            margin-bottom: 20px;
            color: #495057;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .device-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .device-info h4 {
            color: #495057;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .device-info p {
            color: #6c757d;
            line-height: 1.6;
            font-size: 0.9em;
        }

        .data-table-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            font-size: 0.95em;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table td.positive {
            color: #28a745;
            font-weight: 500;
        }

        .data-table td.negative {
            color: #dc3545;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .comparison-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .comparison-chart {
            position: relative;
            height: 350px;
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .control-group {
                flex-direction: column;
            }

            .control-item {
                width: 100%;
            }

            .chart-wrapper {
                height: 300px;
            }
        }

        /* æ•°æ®ç®¡ç†æ ·å¼ */
        .data-management {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .data-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .data-section h4 {
            color: #495057;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-section h4 .icon {
            font-size: 1.2em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.05);
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

        .upload-area .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-area p {
            color: #6c757d;
            margin-bottom: 10px;
        }

        .upload-area .file-types {
            font-size: 0.85em;
            color: #adb5bd;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .data-preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .data-preview th,
        .data-preview td {
            padding: 10px;
            border: 1px solid #e9ecef;
            text-align: left;
        }

        .data-preview th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
        }

        .data-preview tr:hover {
            background: #f8f9fa;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .current-data-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .current-data-info .info-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-data-info .data-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .editable-table {
            width: 100%;
            border-collapse: collapse;
        }

        .editable-table th,
        .editable-table td {
            padding: 12px;
            border: 1px solid #e9ecef;
        }

        .editable-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .editable-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }

        .editable-table input:focus {
            outline: none;
            border-color: #667eea;
        }

        .editable-table .delete-row {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
        }

        .editable-table .delete-row:hover {
            color: #c82333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .modal-content p {
            color: #6c757d;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .template-download {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #e9ecef;
            color: #495057;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .template-download:hover {
            background: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å…¨çƒé«˜ç©ºä½œä¸šå¹³å°ç§Ÿé‡‘ä»·æ ¼è·Ÿè¸ª</h1>
            <p>å®æ—¶ç›‘æ§ä¸»è¦åœ°åŒºè®¾å¤‡ç§Ÿé‡‘èµ°åŠ¿</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="deviceType">è®¾å¤‡ç±»å‹</label>
                    <select id="deviceType">
                        <option value="scissor">å‰ªå‰å¼ (6må¹³å°é«˜åº¦)</option>
                        <option value="articulated">æ›²è‡‚å¼ (14må¹³å°é«˜åº¦)</option>
                        <option value="straight">ç›´è‡‚å¼ (18må¹³å°é«˜åº¦)</option>
                        <option value="mast">æ¡…æŸ±å¼ (4må¹³å°é«˜åº¦)</option>
                    </select>
                </div>
                <div class="control-item">
                    <label for="region">åœ°åŒº</label>
                    <select id="region">
                        <option value="global">å…¨çƒå¹³å‡</option>
                        <option value="asia">äºšæ´²</option>
                        <option value="europe">æ¬§æ´²</option>
                        <option value="north-america">åŒ—ç¾</option>
                        <option value="china">ä¸­å›½</option>
                        <option value="usa">ç¾å›½</option>
                        <option value="uk">è‹±å›½</option>
                        <option value="germany">å¾·å›½</option>
                        <option value="japan">æ—¥æœ¬</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>å½“å‰æœˆç§Ÿé‡‘</h3>
                    <div class="value" id="currentPrice">Â¥0</div>
                    <div class="change" id="priceChange">--</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡æœˆç§Ÿé‡‘</h3>
                    <div class="value" id="avgPrice">Â¥0</div>
                    <div class="change">è¿‡å»12ä¸ªæœˆ</div>
                </div>
                <div class="stat-card">
                    <h3>æœ€é«˜æœˆç§Ÿé‡‘</h3>
                    <div class="value" id="maxPrice">Â¥0</div>
                    <div class="change" id="maxPriceDate">--</div>
                </div>
                <div class="stat-card">
                    <h3>æœ€ä½æœˆç§Ÿé‡‘</h3>
                    <div class="value" id="minPrice">Â¥0</div>
                    <div class="change" id="minPriceDate">--</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('chart')">ä»·æ ¼èµ°åŠ¿å›¾</button>
                <button class="tab" onclick="switchTab('table')">æ•°æ®è¡¨æ ¼</button>
                <button class="tab" onclick="switchTab('comparison')">è®¾å¤‡å¯¹æ¯”</button>
                <button class="tab" onclick="switchTab('dataManage')">ğŸ“Š æ•°æ®ç®¡ç†</button>
            </div>

            <div id="chartTab" class="tab-content active">
                <div class="chart-container">
                    <div class="chart-title">æœˆåº¦ç§Ÿé‡‘ä»·æ ¼èµ°åŠ¿ <span id="chartDataSource" style="font-size: 0.7em; color: #667eea; font-weight: normal;"></span></div>
                    <div class="chart-wrapper">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tableTab" class="tab-content">
                <div class="data-table-container">
                    <div class="chart-title">è¯¦ç»†æ•°æ®è¡¨æ ¼</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æœˆä»½</th>
                                <th>æœˆç§Ÿé‡‘ (Â¥)</th>
                                <th>ç¯æ¯”å˜åŒ–</th>
                                <th>åŒæ¯”å˜åŒ–</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                        </tbody>
                    </table>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="exportToCSV()">å¯¼å‡º CSV</button>
                        <button class="btn btn-secondary" onclick="exportToExcel()">å¯¼å‡º Excel</button>
                    </div>
                </div>
            </div>

            <div id="comparisonTab" class="tab-content">
                <div class="comparison-section">
                    <div class="chart-title">è®¾å¤‡ç±»å‹ä»·æ ¼å¯¹æ¯”</div>
                    <div class="comparison-chart">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="dataManageTab" class="tab-content">
                <div class="data-management">
                    <div class="chart-title">æ•°æ®ç®¡ç†ä¸­å¿ƒ</div>
                    
                    <!-- å½“å‰æ•°æ®çŠ¶æ€ -->
                    <div class="current-data-info" id="dataStatusInfo">
                        <div class="info-text">
                            <span>ğŸ“ˆ</span>
                            <span id="dataSourceText">å½“å‰ä½¿ç”¨: æ¨¡æ‹Ÿæ•°æ®</span>
                        </div>
                        <div class="data-count" id="dataCountText">å…± 0 æ¡è®°å½•</div>
                    </div>

                    <!-- æç¤ºä¿¡æ¯åŒºåŸŸ -->
                    <div id="alertContainer"></div>

                    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                    <div class="data-section">
                        <h4><span class="icon">ğŸ“¤</span>ä¸Šä¼ æ•°æ®æ–‡ä»¶</h4>
                        <p style="color: #6c757d; margin-bottom: 15px; font-size: 0.9em;">
                            æ”¯æŒä¸Šä¼ CSVæ ¼å¼æ–‡ä»¶ï¼Œä¸Šä¼ åå°†è¦†ç›–å½“å‰è®¾å¤‡ç±»å‹å’Œåœ°åŒºçš„æ•°æ®ã€‚
                        </p>
                        <div class="btn-group" style="margin-bottom: 15px;">
                            <span class="template-download" onclick="downloadTemplate()">
                                ğŸ“¥ ä¸‹è½½æ•°æ®æ¨¡æ¿
                            </span>
                        </div>
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click();">
                            <div class="upload-icon">ğŸ“</div>
                            <p><strong>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </strong></p>
                            <p class="file-types">æ”¯æŒæ ¼å¼: CSV (é€—å·åˆ†éš”å€¼æ–‡ä»¶)</p>
                            <input type="file" id="fileInput" accept=".csv" onchange="handleFileUpload(event)">
                        </div>
                        <div class="data-preview" id="uploadPreview" style="display: none;">
                            <h5 style="margin-bottom: 10px; color: #495057;">ğŸ“‹ é¢„è§ˆä¸Šä¼ æ•°æ®</h5>
                            <table id="previewTable">
                                <thead>
                                    <tr>
                                        <th>æœˆä»½</th>
                                        <th>æœˆç§Ÿé‡‘ (Â¥)</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody"></tbody>
                            </table>
                            <div class="btn-group" style="margin-top: 15px;">
                                <button class="btn btn-success" onclick="confirmUpload()">âœ“ ç¡®è®¤å¯¼å…¥</button>
                                <button class="btn btn-secondary" onclick="cancelUpload()">âœ— å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>

                    <!-- æ‰‹åŠ¨å¡«æŠ¥æ•°æ® -->
                    <div class="data-section">
                        <h4><span class="icon">âœï¸</span>æ‰‹åŠ¨å¡«æŠ¥æ•°æ®</h4>
                        <p style="color: #6c757d; margin-bottom: 15px; font-size: 0.9em;">
                            æ‰‹åŠ¨æ·»åŠ æˆ–ä¿®æ”¹ç§Ÿé‡‘æ•°æ®ï¼Œä¿å­˜åå°†è¦†ç›–å½“å‰è®¾å¤‡ç±»å‹å’Œåœ°åŒºçš„åŸæœ‰æ•°æ®ã€‚
                        </p>
                        
                        <!-- æ·»åŠ å•æ¡æ•°æ®è¡¨å• -->
                        <div class="form-grid" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="inputYear">å¹´ä»½</label>
                                <select id="inputYear">
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inputMonth">æœˆä»½</label>
                                <select id="inputMonth">
                                    <option value="1">1æœˆ</option>
                                    <option value="2">2æœˆ</option>
                                    <option value="3">3æœˆ</option>
                                    <option value="4">4æœˆ</option>
                                    <option value="5">5æœˆ</option>
                                    <option value="6">6æœˆ</option>
                                    <option value="7">7æœˆ</option>
                                    <option value="8">8æœˆ</option>
                                    <option value="9">9æœˆ</option>
                                    <option value="10">10æœˆ</option>
                                    <option value="11">11æœˆ</option>
                                    <option value="12">12æœˆ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inputPrice">æœˆç§Ÿé‡‘ (Â¥)</label>
                                <input type="number" id="inputPrice" placeholder="è¯·è¾“å…¥é‡‘é¢" min="0" step="100">
                            </div>
                            <div class="form-group" style="justify-content: flex-end;">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" onclick="addSingleEntry()">â• æ·»åŠ æ•°æ®</button>
                            </div>
                        </div>

                        <!-- å½“å‰æ•°æ®ç¼–è¾‘è¡¨æ ¼ -->
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="editable-table" id="editableDataTable">
                                <thead>
                                    <tr>
                                        <th style="width: 35%;">æœˆä»½</th>
                                        <th style="width: 45%;">æœˆç§Ÿé‡‘ (Â¥)</th>
                                        <th style="width: 20%;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="editableTableBody">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </tbody>
                            </table>
                        </div>

                        <div class="btn-group" style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="saveManualData()">ğŸ’¾ ä¿å­˜æ•°æ®</button>
                            <button class="btn btn-warning" onclick="loadCurrentData()">ğŸ”„ é‡æ–°åŠ è½½</button>
                            <button class="btn btn-danger" onclick="showClearConfirm()">ğŸ—‘ï¸ æ¸…é™¤è‡ªå®šä¹‰æ•°æ®</button>
                        </div>
                    </div>

                    <!-- æ•°æ®è¯´æ˜ -->
                    <div class="data-section" style="background: #e8f4fd;">
                        <h4><span class="icon">ğŸ’¡</span>ä½¿ç”¨è¯´æ˜</h4>
                        <ul style="color: #495057; line-height: 1.8; padding-left: 20px; font-size: 0.9em;">
                            <li><strong>æ•°æ®èŒƒå›´</strong>ï¼šæ¯ç»„æ•°æ®å¯¹åº”ç‰¹å®šçš„è®¾å¤‡ç±»å‹å’Œåœ°åŒºç»„åˆ</li>
                            <li><strong>ä¸Šä¼ æ–‡ä»¶</strong>ï¼šCSVæ–‡ä»¶æ ¼å¼ï¼Œç¬¬ä¸€åˆ—ä¸ºæœˆä»½ï¼ˆæ ¼å¼ï¼š2024-01ï¼‰ï¼Œç¬¬äºŒåˆ—ä¸ºæœˆç§Ÿé‡‘</li>
                            <li><strong>æ‰‹åŠ¨å¡«æŠ¥</strong>ï¼šå¯é€æ¡æ·»åŠ æ•°æ®ï¼Œæˆ–ç›´æ¥åœ¨è¡¨æ ¼ä¸­ä¿®æ”¹ç°æœ‰æ•°æ®</li>
                            <li><strong>æ•°æ®è¦†ç›–</strong>ï¼šä¿å­˜æˆ–å¯¼å…¥æ•°æ®åä¼šè¦†ç›–å½“å‰è®¾å¤‡ç±»å‹å’Œåœ°åŒºçš„åŸæœ‰æ•°æ®</li>
                            <li><strong>æ•°æ®å­˜å‚¨</strong>ï¼šæ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œæ¸…é™¤æµè§ˆå™¨æ•°æ®å¯èƒ½ä¼šä¸¢å¤±</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ç¡®è®¤æ¸…é™¤å¼¹çª— -->
            <div class="modal" id="clearConfirmModal">
                <div class="modal-content">
                    <h3>âš ï¸ ç¡®è®¤æ¸…é™¤æ•°æ®</h3>
                    <p>ç¡®å®šè¦æ¸…é™¤å½“å‰è®¾å¤‡ç±»å‹å’Œåœ°åŒºçš„è‡ªå®šä¹‰æ•°æ®å—ï¼Ÿæ¸…é™¤åå°†æ¢å¤ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ã€‚</p>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="hideClearConfirm()">å–æ¶ˆ</button>
                        <button class="btn btn-danger" onclick="clearCustomData()">ç¡®è®¤æ¸…é™¤</button>
                    </div>
                </div>
            </div>

            <div class="device-info">
                <h4 id="deviceName">å‰ªå‰å¼é«˜ç©ºä½œä¸šå¹³å° (6må¹³å°é«˜åº¦)</h4>
                <p id="deviceDescription">å‰ªå‰å¼é«˜ç©ºä½œä¸šå¹³å°æ˜¯ä¸€ç§å¸¸è§çš„é«˜ç©ºä½œä¸šè®¾å¤‡ï¼Œå…·æœ‰ç¨³å®šæ€§å¥½ã€è½½é‡èƒ½åŠ›å¼ºç­‰ç‰¹ç‚¹ï¼Œé€‚ç”¨äºå®¤å†…å¤–å„ç§ä½œä¸šç¯å¢ƒã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ•°æ®å­˜å‚¨ç®¡ç† ====================
        const STORAGE_KEY = 'rental_price_data';
        let pendingUploadData = null; // å¾…ç¡®è®¤çš„ä¸Šä¼ æ•°æ®

        // è·å–å­˜å‚¨çš„è‡ªå®šä¹‰æ•°æ®
        function getStoredData() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error('è¯»å–å­˜å‚¨æ•°æ®å¤±è´¥:', e);
                return {};
            }
        }

        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveToStorage(deviceType, region, data) {
            try {
                const stored = getStoredData();
                const key = `${deviceType}_${region}`;
                stored[key] = {
                    data: data,
                    updatedAt: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stored));
                return true;
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
                return false;
            }
        }

        // è·å–ç‰¹å®šè®¾å¤‡å’Œåœ°åŒºçš„è‡ªå®šä¹‰æ•°æ®
        function getCustomData(deviceType, region) {
            const stored = getStoredData();
            const key = `${deviceType}_${region}`;
            return stored[key] ? stored[key].data : null;
        }

        // æ¸…é™¤ç‰¹å®šè®¾å¤‡å’Œåœ°åŒºçš„è‡ªå®šä¹‰æ•°æ®
        function removeCustomData(deviceType, region) {
            try {
                const stored = getStoredData();
                const key = `${deviceType}_${region}`;
                delete stored[key];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stored));
                return true;
            } catch (e) {
                console.error('åˆ é™¤æ•°æ®å¤±è´¥:', e);
                return false;
            }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰æ•°æ®
        function hasCustomData(deviceType, region) {
            const customData = getCustomData(deviceType, region);
            return customData && customData.length > 0;
        }

        // ==================== æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå‡½æ•° ====================
        function generatePriceData(deviceType, region, months = 12) {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰æ•°æ®
            const customData = getCustomData(deviceType, region);
            if (customData && customData.length > 0) {
                // ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®
                const sortedData = [...customData].sort((a, b) => new Date(a.month) - new Date(b.month));
                const labels = sortedData.map(item => {
                    const date = new Date(item.month + '-01');
                    return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short' });
                });
                const data = sortedData.map(item => item.price);
                return { labels, data, isCustom: true };
            }

            // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            const basePrices = {
                'scissor': { base: 3500, variance: 500 },
                'articulated': { base: 8500, variance: 1200 },
                'straight': { base: 12000, variance: 2000 },
                'mast': { base: 2500, variance: 400 }
            };

            const regionMultipliers = {
                'global': 1.0,
                'asia': 0.85,
                'europe': 1.15,
                'north-america': 1.2,
                'china': 0.8,
                'usa': 1.25,
                'uk': 1.1,
                'germany': 1.15,
                'japan': 0.95
            };

            const base = basePrices[deviceType].base;
            const variance = basePrices[deviceType].variance;
            const multiplier = regionMultipliers[region] || 1.0;

            const data = [];
            const labels = [];
            const now = new Date();

            for (let i = months - 1; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                labels.push(date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short' }));
                
                // ç”Ÿæˆå¸¦è¶‹åŠ¿å’Œéšæœºæ³¢åŠ¨çš„ä»·æ ¼
                const trend = Math.sin(i / months * Math.PI * 2) * 0.1; // å­£èŠ‚æ€§è¶‹åŠ¿
                const random = (Math.random() - 0.5) * 0.2; // éšæœºæ³¢åŠ¨
                const price = base * multiplier * (1 + trend + random);
                
                data.push(Math.round(price));
            }

            return { labels, data, isCustom: false };
        }

        // è®¾å¤‡ä¿¡æ¯
        const deviceInfo = {
            'scissor': {
                name: 'å‰ªå‰å¼é«˜ç©ºä½œä¸šå¹³å° (6må¹³å°é«˜åº¦)',
                description: 'å‰ªå‰å¼é«˜ç©ºä½œä¸šå¹³å°å…·æœ‰ç»“æ„ç¨³å®šã€è½½é‡èƒ½åŠ›å¼ºã€æ“ä½œç®€ä¾¿ç­‰ç‰¹ç‚¹ã€‚é€‚ç”¨äºå®¤å†…å¤–å„ç§ä½œä¸šç¯å¢ƒï¼Œæ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„é«˜ç©ºä½œä¸šè®¾å¤‡ä¹‹ä¸€ã€‚'
            },
            'articulated': {
                name: 'æ›²è‡‚å¼é«˜ç©ºä½œä¸šå¹³å° (14må¹³å°é«˜åº¦)',
                description: 'æ›²è‡‚å¼é«˜ç©ºä½œä¸šå¹³å°å…·æœ‰çµæ´»æ€§å¼ºã€è·¨è¶Šéšœç¢ç‰©èƒ½åŠ›å¥½ç­‰ç‰¹ç‚¹ã€‚é€‚ç”¨äºå¤æ‚ä½œä¸šç¯å¢ƒï¼Œèƒ½å¤Ÿåˆ°è¾¾ä¼ ç»Ÿè®¾å¤‡éš¾ä»¥è§¦åŠçš„ä½ç½®ã€‚'
            },
            'straight': {
                name: 'ç›´è‡‚å¼é«˜ç©ºä½œä¸šå¹³å° (18må¹³å°é«˜åº¦)',
                description: 'ç›´è‡‚å¼é«˜ç©ºä½œä¸šå¹³å°å…·æœ‰ä½œä¸šé«˜åº¦é«˜ã€å·¥ä½œèŒƒå›´å¤§ç­‰ç‰¹ç‚¹ã€‚é€‚ç”¨äºå¤§å‹å»ºç­‘ã€æ¡¥æ¢ç­‰é«˜ç©ºä½œä¸šé¡¹ç›®ï¼Œæ˜¯é«˜ç©ºä½œä¸šçš„ä¸»åŠ›è®¾å¤‡ã€‚'
            },
            'mast': {
                name: 'æ¡…æŸ±å¼é«˜ç©ºä½œä¸šå¹³å° (4må¹³å°é«˜åº¦)',
                description: 'æ¡…æŸ±å¼é«˜ç©ºä½œä¸šå¹³å°å…·æœ‰ç»“æ„ç´§å‡‘ã€å åœ°é¢ç§¯å°ã€é€‚åˆå®¤å†…ä½œä¸šç­‰ç‰¹ç‚¹ã€‚é€‚ç”¨äºä»“åº“ã€è½¦é—´ç­‰å®¤å†…ç¯å¢ƒçš„é«˜ç©ºä½œä¸šéœ€æ±‚ã€‚'
            }
        };

        let chart = null;
        let comparisonChart = null;
        let currentData = { labels: [], data: [] };
        let previousYearData = { labels: [], data: [] };

        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // å¦‚æœæ˜¯å¯¹æ¯”æ ‡ç­¾ï¼Œæ›´æ–°å¯¹æ¯”å›¾è¡¨
            if (tabName === 'comparison') {
                updateComparisonChart();
            }
        }

        function updateComparisonChart() {
            const region = document.getElementById('region').value;
            const deviceTypes = ['scissor', 'articulated', 'straight', 'mast'];
            const deviceNames = ['å‰ªå‰å¼', 'æ›²è‡‚å¼', 'ç›´è‡‚å¼', 'æ¡…æŸ±å¼'];
            const colors = [
                'rgb(102, 126, 234)',
                'rgb(255, 99, 132)',
                'rgb(75, 192, 192)',
                'rgb(255, 159, 64)'
            ];

            const datasets = deviceTypes.map((type, index) => {
                const { data } = generatePriceData(type, region, 12);
                return {
                    label: deviceNames[index],
                    data: data,
                    borderColor: colors[index],
                    backgroundColor: colors[index] + '40',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                };
            });

            const { labels } = generatePriceData('scissor', region, 12);

            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }

            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': Â¥' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function updateDataTable() {
            const deviceType = document.getElementById('deviceType').value;
            const region = document.getElementById('region').value;
            
            const { labels, data } = generatePriceData(deviceType, region, 12);
            const prevYearData = generatePriceData(deviceType, region, 24);
            
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            data.forEach((price, index) => {
                const row = document.createElement('tr');
                
                const month = labels[index];
                const prevMonthPrice = index > 0 ? data[index - 1] : price;
                const prevYearPrice = prevYearData.data[index + 12] || price;
                
                const monthChange = index > 0 ? ((price - prevMonthPrice) / prevMonthPrice * 100).toFixed(1) : '--';
                const yearChange = ((price - prevYearPrice) / prevYearPrice * 100).toFixed(1);
                
                const monthChangeClass = monthChange !== '--' && parseFloat(monthChange) >= 0 ? 'positive' : 'negative';
                const yearChangeClass = parseFloat(yearChange) >= 0 ? 'positive' : 'negative';
                
                row.innerHTML = `
                    <td>${month}</td>
                    <td><strong>Â¥${price.toLocaleString()}</strong></td>
                    <td class="${monthChangeClass}">${monthChange !== '--' ? (monthChange >= 0 ? '+' : '') + monthChange + '%' : '--'}</td>
                    <td class="${yearChangeClass}">${yearChange >= 0 ? '+' : ''}${yearChange}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportToCSV() {
            const deviceType = document.getElementById('deviceType').value;
            const region = document.getElementById('region').value;
            const deviceTypeName = document.getElementById('deviceType').options[document.getElementById('deviceType').selectedIndex].text;
            const regionName = document.getElementById('region').options[document.getElementById('region').selectedIndex].text;
            
            const { labels, data } = generatePriceData(deviceType, region, 12);
            
            let csv = `è®¾å¤‡ç±»å‹,${deviceTypeName}\n`;
            csv += `åœ°åŒº,${regionName}\n`;
            csv += `æœˆä»½,æœˆç§Ÿé‡‘(Â¥),ç¯æ¯”å˜åŒ–(%)\n`;
            
            data.forEach((price, index) => {
                const month = labels[index];
                const prevMonthPrice = index > 0 ? data[index - 1] : price;
                const change = index > 0 ? ((price - prevMonthPrice) / prevMonthPrice * 100).toFixed(2) : '--';
                csv += `${month},${price},${change}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `é«˜ç©ºä½œä¸šå¹³å°ç§Ÿé‡‘æ•°æ®_${deviceTypeName}_${regionName}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToExcel() {
            // ä½¿ç”¨CSVæ ¼å¼ï¼ŒExcelå¯ä»¥æ‰“å¼€
            exportToCSV();
        }

        function updateChart() {
            const deviceType = document.getElementById('deviceType').value;
            const region = document.getElementById('region').value;
            
            const { labels, data, isCustom } = generatePriceData(deviceType, region);
            currentData = { labels, data };
            
            // æ›´æ–°å›¾è¡¨æ•°æ®æ¥æºæ˜¾ç¤º
            const chartDataSource = document.getElementById('chartDataSource');
            if (chartDataSource) {
                chartDataSource.textContent = isCustom ? '(è‡ªå®šä¹‰æ•°æ®)' : '(æ¨¡æ‹Ÿæ•°æ®)';
                chartDataSource.style.color = isCustom ? '#28a745' : '#667eea';
            }
            
            // æ›´æ–°æ•°æ®è¡¨æ ¼
            updateDataTable();
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const currentPrice = data[data.length - 1];
            const avgPrice = Math.round(data.reduce((a, b) => a + b, 0) / data.length);
            const maxPrice = Math.max(...data);
            const minPrice = Math.min(...data);
            const maxIndex = data.indexOf(maxPrice);
            const minIndex = data.indexOf(minPrice);
            
            const prevPrice = data.length > 1 ? data[data.length - 2] : currentPrice;
            const change = ((currentPrice - prevPrice) / prevPrice * 100).toFixed(1);
            const changeText = change >= 0 ? `+${change}%` : `${change}%`;
            
            document.getElementById('currentPrice').textContent = `Â¥${currentPrice.toLocaleString()}`;
            document.getElementById('avgPrice').textContent = `Â¥${avgPrice.toLocaleString()}`;
            document.getElementById('maxPrice').textContent = `Â¥${maxPrice.toLocaleString()}`;
            document.getElementById('minPrice').textContent = `Â¥${minPrice.toLocaleString()}`;
            
            const priceChangeEl = document.getElementById('priceChange');
            priceChangeEl.textContent = `è¾ƒä¸Šæœˆ ${changeText}`;
            priceChangeEl.className = 'change ' + (change >= 0 ? '' : 'negative');
            
            document.getElementById('maxPriceDate').textContent = labels[maxIndex];
            document.getElementById('minPriceDate').textContent = labels[minIndex];
            
            // æ›´æ–°è®¾å¤‡ä¿¡æ¯
            const info = deviceInfo[deviceType];
            document.getElementById('deviceName').textContent = info.name;
            document.getElementById('deviceDescription').textContent = info.description;
            
            // æ›´æ–°å›¾è¡¨
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æœˆç§Ÿé‡‘ (äººæ°‘å¸)',
                        data: data,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: 'rgb(102, 126, 234)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    family: "'PingFang SC', 'Microsoft YaHei', sans-serif"
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return 'ç§Ÿé‡‘: Â¥' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                },
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ==================== æ•°æ®ç®¡ç†åŠŸèƒ½ ====================
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alertHtml = `
                <div class="alert alert-${type}">
                    <span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}</span>
                    <span>${message}</span>
                </div>
            `;
            container.innerHTML = alertHtml;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // æ›´æ–°æ•°æ®çŠ¶æ€æ˜¾ç¤º
        function updateDataStatus() {
            const deviceType = document.getElementById('deviceType').value;
            const region = document.getElementById('region').value;
            const customData = getCustomData(deviceType, region);
            
            const statusText = document.getElementById('dataSourceText');
            const countText = document.getElementById('dataCountText');
            
            if (customData && customData.length > 0) {
                statusText.textContent = 'å½“å‰ä½¿ç”¨: è‡ªå®šä¹‰æ•°æ®';
                countText.textContent = `å…± ${customData.length} æ¡è®°å½•`;
            } else {
                statusText.textContent = 'å½“å‰ä½¿ç”¨: æ¨¡æ‹Ÿæ•°æ®';
                countText.textContent = 'å…± 12 æ¡è®°å½•';
            }
        }

        // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨
        function initYearSelector() {
            const yearSelect = document.getElementById('inputYear');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'å¹´';
                yearSelect.appendChild(option);
            }
        }

        // ä¸‹è½½CSVæ¨¡æ¿
        function downloadTemplate() {
            const deviceType = document.getElementById('deviceType').value;
            const region = document.getElementById('region').value;
            const deviceTypeName = document.getElementById('deviceType').options[document.getElementById('deviceType').selectedIndex].text;
            const regionName = document.getElementById('region').options[document.getElementById('region').selectedIndex].text;
            
            let csv = 'æœˆä»½,æœˆç§Ÿé‡‘\n';
            const now = new Date();
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                csv += `${month},\n`;
            }
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç§Ÿé‡‘æ•°æ®æ¨¡æ¿_${deviceTypeName}_${regionName}.csv`;
            link.click();
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                showAlert('è¯·ä¸Šä¼ CSVæ ¼å¼çš„æ–‡ä»¶', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim());
                    
                    // è·³è¿‡è¡¨å¤´
                    const dataLines = lines.slice(1);
                    const parsedData = [];
                    
                    for (const line of dataLines) {
                        const parts = line.split(',');
                        if (parts.length >= 2) {
                            const month = parts[0].trim();
                            const price = parseFloat(parts[1].trim());
                            
                            // éªŒè¯æœˆä»½æ ¼å¼ (YYYY-MM)
                            if (/^\d{4}-\d{2}$/.test(month) && !isNaN(price) && price > 0) {
                                parsedData.push({ month, price: Math.round(price) });
                            }
                        }
                    }

                    if (parsedData.length === 0) {
                        showAlert('æœªèƒ½è§£æåˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                        return;
                    }

                    // ä¿å­˜å¾…ç¡®è®¤æ•°æ®å¹¶æ˜¾ç¤ºé¢„è§ˆ
                    pendingUploadData = parsedData;
                    showUploadPreview(parsedData);
                    
                } catch (err) {
                    console.error('è§£ææ–‡ä»¶å¤±è´¥:', err);
                    showAlert('è§£ææ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©ºfile inputï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // æ˜¾ç¤ºä¸Šä¼ é¢„è§ˆ
        function showUploadPreview(data) {
            const preview = document.getElementById('uploadPreview');
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';
            
            const sortedData = [...data].sort((a, b) => new Date(a.month) - new Date(b.month));
            
            for (const item of sortedData) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.month}</td>
                    <td>Â¥${item.price.toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            }
            
            preview.style.display = 'block';
            document.getElementById('uploadArea').style.display = 'none';
        }

        // ç¡®è®¤ä¸Šä¼ 
        function confirmUpload() {
            if (!pendingUploadData) return;
            
            const deviceType = document.getElementById('deviceType').value;
            const region = document.getElementById('region').value;
            
            if (saveToStorage(deviceType, region, pendingUploadData)) {
                showAlert(`æˆåŠŸå¯¼å…¥ ${pendingUploadData.length} æ¡æ•°æ®`, 'success');
                pendingUploadData = null;
                cancelUpload();
                updateChart();
                updateDataStatus();
                loadCurrentData();
            } else {
                showAlert('ä¿å­˜æ•°æ®å¤±è´¥', 'error');
            }
        }

        // å–æ¶ˆä¸Šä¼ 
        function cancelUpload() {
            pendingUploadData = null;
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'block';
        }

        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        function initDragDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('dragover');
                }, false);
            });

            uploadArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload({ target: { files: files } });
                }
            }, false);
        }

        // åŠ è½½å½“å‰æ•°æ®åˆ°ç¼–è¾‘è¡¨æ ¼
        function loadCurrentData() {
            const deviceType = document.getElementById('deviceType').value;
            const region = document.getElementById('region').value;
            const tbody = document.getElementById('editableTableBody');
            tbody.innerHTML = '';
            
            // è·å–æ•°æ®ï¼ˆè‡ªå®šä¹‰æˆ–æ¨¡æ‹Ÿï¼‰
            let dataToLoad;
            const customData = getCustomData(deviceType, region);
            
            if (customData && customData.length > 0) {
                dataToLoad = [...customData].sort((a, b) => new Date(b.month) - new Date(a.month));
            } else {
                // ä»æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ
                const now = new Date();
                dataToLoad = [];
                for (let i = 0; i < 12; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const { data } = generatePriceData(deviceType, region, 12);
                    dataToLoad.push({ month, price: data[11 - i] });
                }
            }
            
            for (const item of dataToLoad) {
                addTableRow(item.month, item.price);
            }
            
            updateDataStatus();
        }

        // æ·»åŠ è¡¨æ ¼è¡Œ
        function addTableRow(month, price) {
            const tbody = document.getElementById('editableTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="month" value="${month}" class="month-input"></td>
                <td><input type="number" value="${price}" min="0" step="100" class="price-input"></td>
                <td><button class="delete-row" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
            `;
            tbody.appendChild(row);
        }

        // åˆ é™¤è¡¨æ ¼è¡Œ
        function deleteRow(btn) {
            const row = btn.closest('tr');
            row.remove();
        }

        // æ·»åŠ å•æ¡æ•°æ®
        function addSingleEntry() {
            const year = document.getElementById('inputYear').value;
            const month = document.getElementById('inputMonth').value;
            const price = document.getElementById('inputPrice').value;
            
            if (!price || parseFloat(price) <= 0) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§Ÿé‡‘é‡‘é¢', 'error');
                return;
            }
            
            const monthStr = `${year}-${String(month).padStart(2, '0')}`;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæœˆä»½
            const tbody = document.getElementById('editableTableBody');
            const existingRows = tbody.querySelectorAll('tr');
            let found = false;
            
            for (const row of existingRows) {
                const monthInput = row.querySelector('.month-input');
                if (monthInput.value === monthStr) {
                    // æ›´æ–°ç°æœ‰è¡Œ
                    row.querySelector('.price-input').value = price;
                    found = true;
                    showAlert(`å·²æ›´æ–° ${monthStr} çš„æ•°æ®`, 'success');
                    break;
                }
            }
            
            if (!found) {
                // æ·»åŠ æ–°è¡Œåˆ°è¡¨æ ¼é¡¶éƒ¨
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="month" value="${monthStr}" class="month-input"></td>
                    <td><input type="number" value="${price}" min="0" step="100" class="price-input"></td>
                    <td><button class="delete-row" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
                `;
                tbody.insertBefore(newRow, tbody.firstChild);
                showAlert(`å·²æ·»åŠ  ${monthStr} çš„æ•°æ®`, 'success');
            }
            
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('inputPrice').value = '';
        }

        // ä¿å­˜æ‰‹åŠ¨å¡«æŠ¥çš„æ•°æ®
        function saveManualData() {
            const tbody = document.getElementById('editableTableBody');
            const rows = tbody.querySelectorAll('tr');
            const data = [];
            
            for (const row of rows) {
                const month = row.querySelector('.month-input').value;
                const price = parseFloat(row.querySelector('.price-input').value);
                
                if (month && !isNaN(price) && price > 0) {
                    data.push({ month, price: Math.round(price) });
                }
            }
            
            if (data.length === 0) {
                showAlert('æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®å¯ä¿å­˜', 'error');
                return;
            }
            
            const deviceType = document.getElementById('deviceType').value;
            const region = document.getElementById('region').value;
            
            if (saveToStorage(deviceType, region, data)) {
                showAlert(`æˆåŠŸä¿å­˜ ${data.length} æ¡æ•°æ®`, 'success');
                updateChart();
                updateDataStatus();
            } else {
                showAlert('ä¿å­˜æ•°æ®å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæ¸…é™¤ç¡®è®¤å¼¹çª—
        function showClearConfirm() {
            document.getElementById('clearConfirmModal').classList.add('show');
        }

        // éšè—æ¸…é™¤ç¡®è®¤å¼¹çª—
        function hideClearConfirm() {
            document.getElementById('clearConfirmModal').classList.remove('show');
        }

        // æ¸…é™¤è‡ªå®šä¹‰æ•°æ®
        function clearCustomData() {
            const deviceType = document.getElementById('deviceType').value;
            const region = document.getElementById('region').value;
            
            if (removeCustomData(deviceType, region)) {
                showAlert('å·²æ¸…é™¤è‡ªå®šä¹‰æ•°æ®ï¼Œæ¢å¤ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®', 'success');
                hideClearConfirm();
                updateChart();
                updateDataStatus();
                loadCurrentData();
            } else {
                showAlert('æ¸…é™¤æ•°æ®å¤±è´¥', 'error');
            }
        }

        // ==================== åˆå§‹åŒ– ====================
        document.getElementById('deviceType').addEventListener('change', function() {
            updateChart();
            updateDataStatus();
            loadCurrentData();
        });
        document.getElementById('region').addEventListener('change', function() {
            updateChart();
            updateDataStatus();
            loadCurrentData();
        });
        
        // åˆå§‹åŒ–
        initYearSelector();
        initDragDrop();
        updateChart();
        updateDataStatus();
        
        // å»¶è¿ŸåŠ è½½ç¼–è¾‘è¡¨æ ¼æ•°æ®ï¼ˆç¡®ä¿DOMå·²å°±ç»ªï¼‰
        setTimeout(loadCurrentData, 100);
    </script>
</body>
</html>